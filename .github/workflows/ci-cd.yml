name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test-frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Run linting
      run: npm run lint

    - name: Run unit tests
      run: npm run test:coverage

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: frontend
        name: frontend-coverage

  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package.json

    - name: Install backend dependencies
      run: |
        cd backend
        npm install

    - name: Run backend unit tests
      run: |
        cd backend
        npm run test:unit

    - name: Run backend integration tests
      run: |
        cd backend
        npm run test:integration

    - name: Upload backend coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./backend/coverage/lcov.info
        flags: backend
        name: backend-coverage

  test-services:
    name: Microservices Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Test Collab Service
      run: |
        cd collab-service
        npm install
        npm test

    - name: Test Notification Service
      run: |
        cd notification-service
        npm install
        npm test

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [test-frontend, test-backend]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Install Playwright
      run: npx playwright install

    - name: Build application
      run: npm run build

    - name: Start backend server
      run: |
        cd backend
        npm start &
        sleep 10

    - name: Run E2E tests
      run: npx playwright test

    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30

  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: [test-frontend, test-backend, test-services, e2e-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Build frontend
      run: npm run build

    - name: Build backend
      run: |
        cd backend
        npm run build 2>/dev/null || echo "No build script for backend"

    - name: Run security audit
      run: npm audit --audit-level moderate

    - name: Deploy to staging
      run: |
        echo "Deploying to staging environment..."
        # Add your deployment commands here
        # Example: rsync, docker push, etc.

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [test-frontend, test-backend, test-services, e2e-tests]
    if: always()

    steps:
    - name: Check test results
      run: |
        if [ "${{ needs.test-frontend.result }}" != "success" ]; then
          echo "Frontend tests failed"
          exit 1
        fi
        if [ "${{ needs.test-backend.result }}" != "success" ]; then
          echo "Backend tests failed"
          exit 1
        fi
        if [ "${{ needs.test-services.result }}" != "success" ]; then
          echo "Services tests failed"
          exit 1
        fi
        if [ "${{ needs.e2e-tests.result }}" != "success" ]; then
          echo "E2E tests failed"
          exit 1
        fi
        echo "All tests passed! âœ…"

  performance-test:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [build-and-deploy]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Artillery
      run: npm install -g artillery

    - name: Run performance tests
      run: |
        # Create a simple load test
        cat > load-test.yml << EOF
        config:
          target: 'http://localhost:5000'
          phases:
            - duration: 60
              arrivalRate: 10
              name: Warm up
            - duration: 120
              arrivalRate: 50
              name: Load test
          defaults:
            headers:
              x-api-key: 'test-key'
        scenarios:
          - name: 'Health check'
            requests:
              - get:
                  url: '/'
          - name: 'API endpoints'
            requests:
              - get:
                  url: '/api/system/consistency'
              - get:
                  url: '/api/system/jobs'
        EOF

        artillery run load-test.yml --output report.json

    - name: Upload performance report
      uses: actions/upload-artifact@v3
      with:
        name: performance-report
        path: report.json
        retention-days: 30